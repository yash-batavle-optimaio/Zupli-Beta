  <div id="optimaio-offers-section" class="optimaio-offers-section">
    <h3 class="optimaio-offers-title">Exclusive Offers üéâ</h3>

    <div id="optimaio-offers-list" class="optimaio-offers-grid">
      <div class="optimaio-offer-card">Loading offers...</div>
    </div>
  </div>

  
  <script>
  (function(){

    /* -----------------------------------------------------------
          ACTION BUTTON RENDERER (STATE-DRIVEN)
          ‚ùó UNCHANGED LOGIC
    ----------------------------------------------------------- */
    function renderCampaignAction(campaignId) {
      const state = window.OptimaioGiftState?.campaigns?.[campaignId];

      if (!state) {
        return `<button class="optimaio-offer-btn disabled">Checking‚Ä¶</button>`;
      }

      const selectedCount = state.gifts.selected.length;
      const maxQty = state.maxQty;
      const eligibleCount = state.gifts.eligible.length;

      if (state.state === "locked") {
        return `<button
  class="optimaio-offer-btn locked"
  data-action="view-store"
  data-campaign="${campaignId}">
  View in store
</button>
`;
      }

      if (selectedCount < maxQty) {
        return `
          <button class="optimaio-offer-btn primary"
            data-action="collect"
            data-campaign="${campaignId}">
            <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <path d="M20 12v10H4V12"/>
  <path d="M2 7h20v5H2z"/>
  <path d="M12 22V7"/>
  <path d="M12 7H7.5a2.5 2.5 0 1 1 0-5C10 2 12 7 12 7z"/>
  <path d="M12 7h4.5a2.5 2.5 0 1 0 0-5C14 2 12 7 12 7z"/>
  </svg> Claim Gift 
          </button>
        `;
      }

      if (
        selectedCount === maxQty &&
        eligibleCount > maxQty &&
        state.canChangeGift
      ) {
        return `
          <button class="optimaio-offer-btn primary"
            data-action="change"
            data-campaign="${campaignId}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-repeat-icon lucide-repeat"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg> Change Gift
          </button>
        `;
      }

      return "";

    }

    /* -----------------------------------------------------------
          GIFT IMAGE RESOLVER (NEW ‚Äì UI ONLY)
    ----------------------------------------------------------- */
    function getGiftPreviewImage(campaign, goal) {
    const state = window.OptimaioGiftState?.campaigns?.[campaign.id];
    if (!state) return null;

    // Prefer selected gift, fallback to eligible
    const targetId =
      state.gifts.selected?.[0] ||
      state.gifts.eligible?.[0];

    if (!targetId) return null;

    /* =========================
      TIERED CAMPAIGN
    ========================= */
    if (campaign.campaignType === "tiered") {
      const products = goal?.products || [];
      const match = products.find(
        p => Number(p.id.split("/").pop()) === targetId
      );
      return match?.image?.url || null;
    }

    /* =========================
      BXGY CAMPAIGN (FIXED)
    ========================= */
    if (campaign.campaignType === "bxgy") {
      const bxgyGoal = campaign.goals?.[0];
      const products = bxgyGoal?.getProducts || [];

      const match = products.find(
        p => Number(p.id.split("/").pop()) === targetId
      );

      return (
        match?.image?.url ||
        match?.featured_image?.url ||
        match?.image ||
        null
      );

    }

    return null;
  }

    
    function getTieredGoalFromKey(campaign, key) {
      const match = key.match(/\d+/); // "3rd goal" ‚Üí 3
      if (!match) return null;
      const index = Number(match[0]) - 1;
      return campaign.goals?.[index] || null;
    }



    function renderOfferPopup({
      campaignId,
      campaignType,
      maxQty,
      products,
      selected
    }) {
      // Remove old popup if exists
      document.getElementById("optimaio-offer-popup")?.remove();
    
      const popup = document.createElement("div");
      popup.id = "optimaio-offer-popup";
      popup.className = "optimaio-offer-popup";
    
      popup.innerHTML = `
        <div class="optimaio-offer-popup__backdrop"></div>
        <div class="optimaio-offer-popup__card">
          <div class="optimaio-offer-popup__header">
    <div class="optimaio-offer-popup__icon"><svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <path d="M20 12v10H4V12"/>
  <path d="M2 7h20v5H2z"/>
  <path d="M12 22V7"/>
  <path d="M12 7H7.5a2.5 2.5 0 1 1 0-5C10 2 12 7 12 7z"/>
  <path d="M12 7h4.5a2.5 2.5 0 1 0 0-5C14 2 12 7 12 7z"/>
  </svg></div>
    <h3>Free gifts Unlocked</h3>
    <p>
      Choose any ${maxQty} free gifts
      <span class="optimaio-offer-popup__count">
        ${selected.size}/${maxQty}
      </span>
    </p>
  </div>

  <div class="optimaio-offer-popup__list">

            ${products.map(p => {
              const vid = Number(p.id.split("/").pop());
              const isSelected = selected.has(vid);
    
              return `
                <div class="optimaio-offer-popup__row ${isSelected ? "selected" : ""}"
      data-vid="${vid}">

                  <img src="${p.image?.url || p.featured_image?.url || p.image || ""}" />

  <div class="optimaio-offer-popup__info">
    <p class="title">${p.productTitle || p.title}</p>
    <p class="price">
      <span class="strike">INR ${p.price || ""}</span>
      <span class="free">Free</span>
    </p>
  </div>

  <input
    type="checkbox"
    class="optimaio-offer-popup__checkbox"
    ${isSelected ? "checked" : ""}
  />


                </div>
              `;
            }).join("")}
          </div>
    
          <div class="optimaio-offer-popup__actions">
            <button class="optimaio-offer-cancel">Cancel</button>
            <button class="optimaio-offer-confirm">Confirm</button>
          </div>
        </div>
      `;
    
      const cartDrawer =
    document.querySelector("#optimaio-cart-drawer") ||
    document.querySelector(".optimaio-cart-drawer");

  if (!cartDrawer) {
    console.warn("Cart drawer not found");
    return;
  }

  cartDrawer.appendChild(popup);

    
      // Close
      popup.querySelector(".optimaio-offer-cancel").onclick = () => {
        popup.remove();
      };
      
    
      // Selection logic
      const chosen = new Set(selected);
    
      popup.querySelectorAll(".optimaio-offer-popup__row").forEach(row => {
        const checkbox = row.querySelector(".optimaio-offer-popup__checkbox");
        const vid = Number(row.dataset.vid);
      
        row.onclick = () => {
      
          // üîí Radio behaviour when only 1 gift allowed
          if (maxQty === 1) {
            chosen.clear();
            popup.querySelectorAll(".optimaio-offer-popup__row").forEach(r => {
              r.classList.remove("selected");
              r.querySelector(".optimaio-offer-popup__checkbox").checked = false;
            });
          }
      
          if (chosen.has(vid)) {
            chosen.delete(vid);
            row.classList.remove("selected");
            checkbox.checked = false;
          } else if (chosen.size < maxQty) {
            chosen.add(vid);
            row.classList.add("selected");
            checkbox.checked = true;
          }
        };
      });
      
    
      // Confirm
      popup.querySelector(".optimaio-offer-confirm").onclick = async () => {
        popup.remove();
      
        document.dispatchEvent(
          new CustomEvent("optimaio:offer:confirm", {
            detail: {
              campaignId,
              campaignType,
              selectedVariantIds: Array.from(chosen)
            }
          })
        );
      
        // üîì Allow engine AFTER cart updates start
        {% comment %} setTimeout(() => {
          window.__optimaioPopupOpen = false;
        }, 0); {% endcomment %}
      };
      
    }
    


    function openOfferGiftPopup({ campaign, campaignState }) {
      console.log("Opening popup for:", campaign.id);
    
      const campaignType = campaign.campaignType;
      const maxQty = campaignState.maxQty;
      const selected = new Set(campaignState.gifts.selected);
    
      // 1Ô∏è‚É£ Resolve correct goal
      const goal =
        campaignType === "tiered"
          ? campaign.goals.find(g => g.type === "free_product")
          : campaign.goals[0];
    
      if (!goal) {
        console.warn("No free_product goal found", campaign);
        return;
      }
    
      // 2Ô∏è‚É£ Resolve products correctly
      const products =
        campaignType === "tiered"
          ? goal.products
          : goal.getProducts;
    
      if (!products || !products.length) {
        console.warn("No products found for popup", goal);
        return;
      }
    
      // 3Ô∏è‚É£ Ensure popup renderer exists
      if (typeof renderOfferPopup !== "function") {
        console.error("renderOfferPopup is not defined");
        return;
      }

      // üîí Tell engine a popup is open
window.__optimaioPopupOpen = true;
    
      // 4Ô∏è‚É£ Open popup
      renderOfferPopup({
        campaignId: campaign.id,
        campaignType,
        maxQty,
        products,
        selected
      });
    }
    
    

    function renderViewGiftPopup({ products }) {
      document.getElementById("optimaio-view-gift-popup")?.remove();
    
      const popup = document.createElement("div");
      popup.id = "optimaio-view-gift-popup";
      popup.className = "optimaio-offer-popup";
    
      const isMultiple = products.length > 1;
    
      popup.innerHTML = `
  <div class="optimaio-offer-popup__backdrop"></div>

  <div class="optimaio-offer-popup__card">
    <div class="optimaio-offer-popup__header view-gift-header">
      <div class="optimaio-offer-popup__icon">
      <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <path d="M20 12v10H4V12"/>
  <path d="M2 7h20v5H2z"/>
  <path d="M12 22V7"/>
  <path d="M12 7H7.5a2.5 2.5 0 1 1 0-5C10 2 12 7 12 7z"/>
  <path d="M12 7h4.5a2.5 2.5 0 1 0 0-5C14 2 12 7 12 7z"/>
  </svg>
      </div>
      <h3>Free Gift</h3>

      <button class="optimaio-popup-close" aria-label="Close">‚úï</button>

      <p>
        ${isMultiple
          ? "These gifts unlock once cart conditions are met"
          : "This gift unlocks once cart conditions are met"}
      </p>
    </div>

    
          <div class="optimaio-offer-popup__list">
            ${products.map(p => `
              <div class="optimaio-offer-popup__row">
                <img src="${p.image?.url || p.featured_image?.url || p.image}" />
    
                <div class="optimaio-offer-popup__info">
                  <p class="title">${p.productTitle || p.title}</p>
                  <p class="price">
                    <span class="strike">INR ${p.price}</span>
                    <span class="free">Free</span>
                  </p>
                </div>
    
                <button
                  class="optimaio-view-gift-btn"
                  data-handle="${p.productHandle}">
                  Show Gift
                </button>
              </div>
            `).join("")}
          </div>
        </div>
      `;
    
      const cartDrawer =
        document.querySelector("#optimaio-cart-drawer") ||
        document.querySelector(".optimaio-cart-drawer");
    
      if (!cartDrawer) return;
    
      cartDrawer.appendChild(popup);

      popup.querySelector(".optimaio-popup-close").onclick = () => {
        popup.remove();
      };      
    
      // Close on backdrop
      popup.querySelector(".optimaio-offer-popup__backdrop").onclick = () => {
        popup.remove();
      };
    
      // Redirect buttons
      popup.querySelectorAll(".optimaio-view-gift-btn").forEach(btn => {
        btn.onclick = () => {
          const handle = btn.dataset.handle;
          window.location.href = `/products/${handle}`;
        };
      });
    }

    
    function resolveGiftProducts(campaign) {
      // Tiered campaign ‚Üí free_product goal
      if (campaign.campaignType === "tiered") {
        const goal = campaign.goals.find(g => g.type === "free_product");
        return goal?.products || [];
      }
    
      // BXGY campaign ‚Üí getProducts
      if (campaign.campaignType === "bxgy") {
        const goal = campaign.goals?.[0];
        return goal?.getProducts || [];
      }
    
      return [];
    }
    
    

    /* -----------------------------------------------------------
          OFFER LOADER
    ----------------------------------------------------------- */
    async function loadOffers() {
      const wrapper = document.getElementById("optimaio-offers-list");
      if (!wrapper) return;

      wrapper.innerHTML = `<div class="optimaio-offer-card">Loading offers...</div>`;

      let data = await window.getCampaignData();
      const campaigns = Array.isArray(data) ? data : (data?.campaigns || []);

      wrapper.innerHTML = "";

      const active = campaigns.filter(c => c.status === "active");

      active.forEach(campaign => {


        const campaignState = window.OptimaioGiftState?.campaigns?.[campaign.id];

  const statusBadge =
    campaignState?.state === "locked"
      ? `<span class="optimaio-offer-badge locked">Locked</span>`
      : `<span class="optimaio-offer-badge unlocked">Unlocked</span>`;


        /* =========================
          BXGY CAMPAIGN
        ========================== */
        if (campaign.campaignType === "bxgy") {
          const { offerTitle, offerSubtitle } = campaign.content || {};
          if (!offerTitle && !offerSubtitle) return;

          const goal = campaign.goals?.[0];
          const giftImg = getGiftPreviewImage(campaign, goal);




          const card = document.createElement("div");
          card.className = "optimaio-offer-card";

          let html = `
            <div class="optimaio-offer-left">
              ${
                giftImg
                  ? `<img class="optimaio-offer-gift-img" src="${giftImg}" />`
                  : `<span class="optimaio-offer-icon">üéÅ</span>`
              }
            </div>

            <div class="optimaio-offer-right">
              <h4 class="optimaio-offer-title">${offerTitle}</h4>
              ${offerSubtitle ? `<p class="optimaio-offer-subtitle">${offerSubtitle}</p>` : ""}
              <div class="optimaio-offer-status">
      ${statusBadge}
    </div>
              </div>
          `;

          html += `
            <div class="optimaio-offer-actions">
              ${renderCampaignAction(campaign.id)}
            </div>
          `;

          card.innerHTML = html;
          wrapper.appendChild(card);
          return;
        }

        /* =========================
          TIERED CAMPAIGN
        ========================== */
        if (campaign.campaignType === "tiered") {
          const contentObj = campaign.content || {};
          let contentKeys = Object.keys(contentObj);
          if (!contentKeys.length) return;

          contentKeys = contentKeys.sort((a, b) => parseInt(a) - parseInt(b));

          contentKeys.forEach(key => {
            const content = contentObj[key];
            const title = content?.offerTitle;
            const subtitle = content?.offerSubtitle;
            if (!title && !subtitle) return;
          
            const goal = getTieredGoalFromKey(campaign, key);
            if (!goal) return;
          
            const giftImg =
              goal.type === "free_product"
                ? getGiftPreviewImage(campaign, goal)
                : null;
          

            let icon = "‚ú®";
            if (goal?.type === "free_shipping") icon = "üöö";
            else if (goal?.type === "order_discount") icon = "üè∑Ô∏è";
            else if (goal?.type === "free_product") icon = "üéÅ";

            const card = document.createElement("div");
            card.className = "optimaio-offer-card";

            let html = `
              <div class="optimaio-offer-left">
                ${
                  giftImg
                    ? `<img class="optimaio-offer-gift-img" src="${giftImg}" />`
                    : `<span class="optimaio-offer-icon">${icon}</span>`
                }
              </div>

              <div class="optimaio-offer-right">
                <h4 class="optimaio-offer-title">${title}</h4>
                ${subtitle ? `<p class="optimaio-offer-subtitle">${subtitle}</p>` : ""}
              <div class="optimaio-offer-status">
      ${statusBadge}
    </div>
                </div>
            `;

            if (goal.type === "free_product") {
              html += `
                <div class="optimaio-offer-actions">
                  ${renderCampaignAction(campaign.id)}
                </div>
              `;
            }
            

            card.innerHTML = html;
            wrapper.appendChild(card);
          });
        }
      });

      if (!wrapper.children.length) {
        wrapper.innerHTML = `<div class="optimaio-offer-card">No offers available</div>`;
      }
    }

    /* -----------------------------------------------------------
          BUTTON CLICK HANDLER (UNCHANGED)
    ----------------------------------------------------------- */
    document.addEventListener("click", async e => {
      const btn = e.target.closest(".optimaio-offer-btn");
      if (!btn) return;
    
      const action = btn.dataset.action;
      const campaignId = btn.dataset.campaign;
      if (!action || !campaignId) return;
    
      const data = await window.getCampaignData();
      const campaigns = Array.isArray(data) ? data : data.campaigns;
      const campaign = campaigns.find(c => c.id === campaignId);
      if (!campaign) return;
    
      const state = window.OptimaioGiftState?.campaigns?.[campaignId];
    
      /* üîí VIEW IN STORE (LOCKED) */
      if (action === "view-store") {
        const products = resolveGiftProducts(campaign);
        if (!products.length) return;
    
        renderViewGiftPopup({ products });
        return;
      }
    
      /* üéÅ NORMAL CLAIM / CHANGE FLOW */
      if (!state) return;
    
      openOfferGiftPopup({
        campaign,
        campaignState: state
      });
    });
    

    /* -----------------------------------------------------------
          AUTO REFRESH ON STATE UPDATE
    ----------------------------------------------------------- */
    document.addEventListener("optimaio:gifts:updated", loadOffers);
    document.addEventListener("DOMContentLoaded", loadOffers);

  })();
  </script>

  <script>
    /* ============================================================
      OFFER POPUP CONFIRM HANDLER
      - Applies gifts WITHOUT rerunning engine
    ============================================================ */
    
    document.addEventListener("optimaio:offer:confirm", async (e) => {
      const { campaignId, campaignType, selectedVariantIds } = e.detail;
    
      const selectedSet = new Set(selectedVariantIds);
    
      // 1Ô∏è‚É£ Always work on latest cart
      const cart = await window.OptimaioCartController.getCart();
    
      /* --------------------------------------------------
        2Ô∏è‚É£ Find gifts ONLY from this campaign
      -------------------------------------------------- */
      const currentGiftLines = cart.items.filter(item => {
        if (campaignType === "tiered") {
          return item.properties?.isFreeGift === "true";
        }
    
        if (campaignType === "bxgy") {
          return (
            item.properties?.isBXGYGift === "true" &&
            item.properties?.bxgyCampaignId === campaignId
          );
        }
    
        return false;
      });
    
      /* --------------------------------------------------
        3Ô∏è‚É£ REMOVE gifts that are no longer selected
      -------------------------------------------------- */
      for (const line of currentGiftLines) {
        if (!selectedSet.has(line.variant_id)) {
          await fetch("/cart/change.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id: line.key,
              quantity: 0
            })
          });
        }
      }
    
      /* --------------------------------------------------
        4Ô∏è‚É£ ADD newly selected gifts
      -------------------------------------------------- */
      for (const vid of selectedSet) {
        const alreadyExists = currentGiftLines.some(
          g => g.variant_id === vid
        );
    
        if (alreadyExists) continue;
    
        const properties =
          campaignType === "bxgy"
            ? { isBXGYGift: "true", bxgyCampaignId: campaignId }
            : { isFreeGift: "true" };
    
        await fetch("/cart/add.js", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: vid,
            quantity: 1,
            properties
          })
        });
      }
    
      /* --------------------------------------------------
        5Ô∏è‚É£ Refresh cart UI ONLY
      -------------------------------------------------- */
      document.dispatchEvent(
        new CustomEvent("optimaio:cart:refresh")
      );
       // üîì RELEASE HERE ‚Äî AFTER EVERYTHING
  window.__optimaioPopupOpen = false;
    });
    </script>
    
  <style>

    /* ===============================
    OFFER ACTION BUTTON STYLES
    (STYLE ONLY ‚Äì NO LOGIC)
  ================================ */

  /* Base button */
  .optimaio-offer-btn {
    width: 100%;
    padding: 6px 8px 6px 6px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s ease;
    background: transparent;
    border: 1px solid var(--accent);
  }

  /* Primary ‚Äì Claim Gift */
  .optimaio-offer-btn.primary {
    background: var(--accent);
    color: var(--accent-contrast);
  }

  /* Secondary ‚Äì Change Gift */
  .optimaio-offer-btn.secondary {
    background: var(--bg-soft);
    color: var(--text-primary);
    border: 1px solid var(--border-subtle);
  }

  /* Success ‚Äì Unlocked */
  .optimaio-offer-btn.success {
    background: #e7f5ec;
    color: #1a7f37;
    cursor: default;
  }



  /* Disabled state (generic) */
  .optimaio-offer-btn:disabled {
    cursor: not-allowed;
  }

  .optimaio-view-gift-btn {
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    background: var(--accent);
    color: var(--accent-contrast);
    white-space: nowrap;
  }
  
  .optimaio-view-gift-btn:hover {
    transform: translateY(-1px);
  }
  

  /* Hover effects (only when enabled) */
  .optimaio-offer-btn:not(:disabled):hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.06);
  }

    .optimaio-offers-section {
      background-color: var(--bg-secondary);
      padding: 4px 10px;
    }
    .optimaio-offer-left {
      width: 56px;
      height: 56px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .optimaio-offer-gift-img {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      object-fit: cover;
      background: #f6f6f6;
    }
    /* ===============================
    OFFER POPUP (REQUIRED STYLES)
  ================================ */

  .optimaio-offer-popup {
    position: fixed;
    inset: 0;
    z-index: 99999; /* ABOVE cart drawer */
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.6);
  }

  .optimaio-offer-popup__backdrop {
    position: absolute;
    inset: 0;
    
  }

  .optimaio-offer-popup__card {
    position: relative;
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 15px;
    width: 92%;
    max-width: 420px;
    max-height: 80vh;
    z-index: 1;
  }

  /* HEADER */
  .optimaio-offer-popup__header {
    text-align: center;
    margin-bottom: 16px;
  }

  .optimaio-offer-popup__icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 8px;
    border-radius: 50%;
    background: var(--accent);
    color:var(--accent-contrast);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  .optimaio-offer-popup__header h3 {
    color: var(--text-primary);
    margin: 0;
    font-size: 18px;
    font-weight: 700;
  }


  .optimaio-popup-close {
    position: absolute;
    top: 12px;
    right: 12px;
    background: transparent;
    border: none;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    color: #666;
  }
  
  .optimaio-popup-close:hover {
    color: #000;
  }
  
  .optimaio-offer-popup__header p {
    font-size: 14px;
    color: var(--text-secondary);
    margin:  5px;
  }

  .optimaio-offer-popup__count {
    background:var(--bg-soft);
    border-radius: 12px;
    padding: 2px 8px;
    margin-left: 6px;
    font-weight: 600;
  }

  /* LIST */
  .optimaio-offer-popup__list {
    border-top: 1px solid #eee;
    overflow-y: auto;
    max-height: 45vh; /* üëà controls product scroll height */
    padding-right: 4px; /* avoids scrollbar overlap */
  }

  .optimaio-offer-popup__row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }

  .optimaio-offer-popup__row img {
    width: 48px;
    height: 48px;
    object-fit: cover;
    border-radius: 8px;
  }

  .optimaio-offer-popup__info {
    flex: 1;
  }

  .optimaio-offer-popup__info .title {
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 4px;
  }

  .optimaio-offer-popup__info .price {
    color: var(--text-muted);
    font-size: 12px;
    margin:0;
  }

  /* ===============================
    OFFER STATUS BADGE (INLINE)
  =============================== */

  .optimaio-offer-status {
    margin-top: 2px;
  }

  /* Base badge */
  .optimaio-offer-badge {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 999px;
    line-height: 1;
  }

  /* Locked */
  .optimaio-offer-badge.locked {
    color: var(--text-muted);
    border: 1px solid var(--border);
  }

  /* Unlocked */
  .optimaio-offer-badge.unlocked {
    background: var(--bg-soft);
    color: var(--discount-text);
    border: 1px solid var(--bg-soft);
  }


  .strike {
    text-decoration: line-through;
    color: var(--text-muted)  ;
    margin-right: 6px;
  }

  .free {
    background:var(--bg-soft);
    color:var(--discount-text);
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 6px;
  }

  /* CHECK */
  /* CHECKBOX STYLE */
  /* Optimaio unified checkbox ‚Äî FINAL */
.optimaio-offer-popup__checkbox {
  appearance: none;
  -webkit-appearance: none;

  width: 18px;
  height: 18px;
  min-width: 18px;

  border-radius: 4px;
  border: 2px solid #cfcfcf;
  background: #fff;

  display: flex;
  align-items: center;
  justify-content: center;

  margin-left: auto;        /* push right */
  transform: translateY(-1px); /* üî• optical centering */

  transition: all 0.15s ease;
  pointer-events: none;     /* row controls click */
}

/* Checked state */
.optimaio-offer-popup__checkbox:checked {
  background: var(--accent);
  border-color: var(--accent);
}

/* Tick */
.optimaio-offer-popup__checkbox:checked::after {
  content: "‚úì";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -55%); /* üî• optical centering */
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  line-height: 1;
}





  /* FOOTER */
  .optimaio-offer-popup__actions {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding-top: 12px;
    display: flex;
    justify-content: space-between;
  }


  .optimaio-offer-popup__item img {
    width: 100%;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
  }

  .optimaio-offer-popup__item.selected {
    border-color: #d48b8b;
    background: #fdeaea;
  }

  .optimaio-offer-popup__actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .optimaio-offer-popup__actions button {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
  }

  .optimaio-offer-cancel {
    background: var(--bg-soft);
  }

  .optimaio-offer-confirm {
    background: var(--accent);
    color: var(--accent-contrast);
  }

    
  </style>