<div id="optimaio-progress-container"></div>


 <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script> 

<script>
(() => {
  if (window.__OptimaioProMilestonesInit) return;
  window.__OptimaioProMilestonesInit = true;

  /* =============================
   CONFETTI FEATURE FLAG
============================= */
const offerAnimation =
  window.__OPTIMAIO_CART__?.settings?.cartFeatures?.offerAnimation;

const CONFETTI_ENABLED = offerAnimation === "confetti";


  // ðŸ”¥ Warm campaign cache early (safe, deduped)
if (typeof getCampaignData === "function") {
  getCampaignData().catch(() => null);
}


  window.__OptimaioDrawerOpen = false;
function isDrawerOpen() {
  const drawer = document.querySelector(".optimaio-cart-drawer");
  return drawer && drawer.classList.contains("open");
}



  // Track milestone achievements (resets when user drops below)
window.__OptimaioAchievedMilestones = window.__OptimaioAchievedMilestones || new Set();


  // UI element cache (performance only)
const uiCache = {
  fill: null,
  msg: null,
  milestones: null,
  container: null
};

function cacheUI() {
  uiCache.fill = document.querySelector(".optimaio-progress-fill");
  uiCache.msg = document.querySelector(".optimaio-progress-message");
  uiCache.milestones = document.querySelectorAll(".optimaio-milestone");
  uiCache.container = document.getElementById("optimaio-progress-container");
}


  function fillTemplate(str, vars) {
    return str.replace(/\{(\w+)\}/g, (_, key) => vars[key] ?? "");
  }

 async function fetchCampaign() {
  const start = performance.now(); // â± START TIMER

  try {
    if (typeof getCampaignData !== "function") {
      console.warn("âš ï¸ Progress Bar: getCampaignData() is NOT available!");
      return null;
    }

    const data = await getCampaignData();

    const end = performance.now();
    console.log(`âš¡ Progress Bar Campaign fetched in ${Math.round(end - start)} ms`, data);

    return data;

  } catch (err) {
    const end = performance.now();
    console.warn(`âš ï¸ Progress Bar Campaign fetch failed after ${Math.round(end - start)} ms`, err);
    return null;
  }
}




  function extractSteps(data) {
    if (!data?.campaigns) return null;
    
  // 1ï¸âƒ£ Filter ONLY tiered / cart-goal campaigns (NOT bxgy)
  const tieredCampaigns = data.campaigns
    .filter(c =>
      c.status === "active" &&
      c.campaignType === "tiered" &&           // ignore bxgy
      Array.isArray(c.goals) &&
      c.goals.length > 0
    );

  // 2ï¸âƒ£ No valid tiered campaigns â†’ no progress bar
  if (tieredCampaigns.length === 0) return null;

  // 3ï¸âƒ£ Pick the highest priority (lowest number)
  tieredCampaigns.sort((a, b) => (a.priority ?? 999) - (b.priority ?? 999));

  const active = tieredCampaigns[0]; // the winning campaign
    if (!active || !active.goals || active.goals.length === 0) return null;

    const content = active.content || {};

    function ordinal(n) {
      if (n === 1) return "1st";
      if (n === 2) return "2nd";
      if (n === 3) return "3rd";
      return n + "th";
    }

    const steps = active.goals
      .filter(g => Number(g.target) > 0)
      .sort((a, b) => a.target - b.target)
      .map((g, index) => {
        const goalKey = `${ordinal(index + 1)} goal`;
        const goalContent = content[goalKey] || {};

        const defaultLabel =
          g.type === "free_shipping" ? "Free Shipping" :
          g.type === "order_discount" ? `${g.discountValue}% Off` :
          g.type === "free_product" ? "Free Gift" :
          "Reward";

        return {
          threshold: Number(g.target),
          beforeLabel: goalContent.giftTitleBefore?.trim() || defaultLabel,
          afterLabel: goalContent.giftTitleAfter?.trim() || defaultLabel,
          svg: `<svg width="40" height="16" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_887_20826)"><path d="M2.5 6.00016C2.5 5.82335 2.57024 5.65378 2.69526 5.52876C2.82029 5.40373 2.98986 5.3335 3.16667 5.3335H13.8333C14.0101 5.3335 14.1797 5.40373 14.3047 5.52876C14.4298 5.65378 14.5 5.82335 14.5 6.00016V7.3335C14.5 7.51031 14.4298 7.67988 14.3047 7.8049C14.1797 7.92992 14.0101 8.00016 13.8333 8.00016H3.16667C2.98986 8.00016 2.82029 7.92992 2.69526 7.8049C2.57024 7.67988 2.5 7.51031 2.5 7.3335V6.00016Z" stroke="#000000" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M8.5 5.3335V14.0002" stroke="#000000" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M13.1668 8V12.6667C13.1668 13.0203 13.0264 13.3594 12.7763 13.6095C12.5263 13.8595 12.1871 14 11.8335 14H5.16683C4.81321 14 4.47407 13.8595 4.22402 13.6095C3.97397 13.3594 3.8335 13.0203 3.8335 12.6667V8" stroke="#000000" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M5.50016 5.33314C5.05814 5.33314 4.63421 5.15754 4.32165 4.84498C4.00909 4.53242 3.8335 4.1085 3.8335 3.66647C3.8335 3.22444 4.00909 2.80052 4.32165 2.48796C4.63421 2.1754 5.05814 1.9998 5.50016 1.9998C6.14329 1.9886 6.77351 2.30064 7.30865 2.89524C7.84379 3.48984 8.25901 4.33941 8.50016 5.33314C8.74131 4.33941 9.15653 3.48984 9.69167 2.89524C10.2268 2.30064 10.857 1.9886 11.5002 1.9998C11.9422 1.9998 12.3661 2.1754 12.6787 2.48796C12.9912 2.80052 13.1668 3.22444 13.1668 3.66647C13.1668 4.1085 12.9912 4.53242 12.6787 4.84498C12.3661 5.15754 11.9422 5.33314 11.5002 5.33314" stroke="#000000" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0_887_20826"><rect width="16" height="16" fill="#E0F7F4" transform="translate(0.5)"></rect></clipPath></defs></svg>`
        };
      });

    return { steps, trackType: active.trackType, content };
  }

  function renderUI(container, config) {
    container.innerHTML = `
      <div class="optimaio-progress-message"></div>
      <div class="optimaio-progress-bar-container">
      <div class="optimaio-progress-bar">
        <div class="optimaio-progress-fill"></div>
        <div class="optimaio-progress-milestones">
          ${config.steps.map(s => `
            <div class="optimaio-milestone">
              <div class="optimaio-milestone-icon">${s.svg}</div>
              <div class="optimaio-milestone-label">${s.beforeLabel}</div>
            </div>
          `).join("")}
        </div>
      </div>
      </div>
    `;

    if (!config.steps?.length) return;
    const maxT = config.steps.at(-1)?.threshold;
    if (!maxT) return;

    document.querySelectorAll(".optimaio-milestone").forEach((m, i) => {
  const total = config.steps.length;
  const pct = ((i + 1) / total) * 100;
  m.style.left = pct + "%";
});

cacheUI();

  }

      function isGiftItem(item) {
  return item.properties?.isFreeGift === "true" || item.properties?.isBXGYGift === "true";
}

function ensureDrawerConfettiCanvas() {
  const drawer = document.querySelector(".optimaio-cart-drawer");
  if (!drawer) return null;

  let canvas = document.getElementById("optimaio-cart-confetti");
  if (!canvas) {
    canvas = document.createElement("canvas");
    canvas.id = "optimaio-cart-confetti";
    drawer.appendChild(canvas);

    // âœ… SET SIZE ONLY ONCE (BEFORE worker)
    canvas.width = drawer.clientWidth;
    canvas.height = drawer.clientHeight;
  }

  return canvas;
}


let drawerConfettiInstance = null;

function fireConfetti() {
  if (!CONFETTI_ENABLED) return;
  if (!isDrawerOpen()) return;


  const canvas = ensureDrawerConfettiCanvas();
  if (!canvas) return;

  if (!drawerConfettiInstance) {
    drawerConfettiInstance = confetti.create(canvas, {
      resize: false,   // â›” IMPORTANT
      useWorker: true  // âœ… OK now
    });
  }

  drawerConfettiInstance({
    particleCount: 200,
    spread: 90,
    startVelocity: 55,
    gravity: 1.3,
    origin: { x: 1, y: 1 }
  });
}



  async function updateProgress(cart, config) {
    if (!isDrawerOpen()) return;
    if (!config || !config.steps?.length) return;

    const { fill, msg, milestones, container } = uiCache;


    if (!fill || !msg || milestones.length === 0) return;

    // Hide progress bar if cart is empty
{% comment %} const container = document.getElementById("optimaio-progress-container"); {% endcomment %}

if (cart.items.length === 0) {
  container.style.display = "none";
  window.__OptimaioAchievedMilestones = new Set(); // reset all
  return;
}
 else {
  container.style.display = "block";
}


    const subtotal = cart.items
  .filter(i => !isGiftItem(i))
  .reduce((t, i) => t + i.final_line_price, 0) / 100;

    const qty = cart.items
  .filter(i => !isGiftItem(i))
  .reduce((t, i) => t + Number(i.quantity || 0), 0);

    const value = config.trackType === "quantity" ? qty : subtotal;

    const maxT = config.steps.at(-1)?.threshold;
    if (!maxT) return;

    // Equally spaced milestone positions
const total = config.steps.length;
const positions = config.steps.map((s, i) => ((i + 1) / total) * 100);

// Thresholds array
const thresholds = config.steps.map(s => s.threshold);

// Find active milestone index
let idx = thresholds.findIndex(t => value < t);
if (idx === -1) {
  // All reached
  fill.style.width = "100%";
} else if (idx === 0) {
  // Before first milestone
  const pct = (value / thresholds[0]) * (positions[0]);
  fill.style.width = pct + "%";
} else {
  // Between milestones
  const prevT = thresholds[idx - 1];
  const nextT = thresholds[idx];
  const prevP = positions[idx - 1];
  const nextP = positions[idx];

  const range = (value - prevT) / (nextT - prevT);
  const pct = prevP + range * (nextP - prevP);

  fill.style.width = pct + "%";
}


   config.steps.forEach((s, i) => {
  const isActive = value >= s.threshold;
  const milestoneEl = milestones[i];

  // --- UI Update ---
  milestoneEl.classList.toggle("active", isActive);
  milestoneEl.querySelector(".optimaio-milestone-label").textContent =
    isActive ? s.afterLabel : s.beforeLabel;

  // --- CONFETTI LOGIC FOR ALL MILESTONES ---
  if (isActive) {
    // Fire confetti ONLY when milestone becomes newly achieved
    if (!window.__OptimaioAchievedMilestones.has(i)) {
      if (isDrawerOpen()) {
  fireConfetti();
}

      window.__OptimaioAchievedMilestones.add(i);
      console.log("ðŸŽ‰ Milestone reached â†’", i + 1);
    }
  } else {
    // If user falls below â†’ reset milestone so we can celebrate again later
    if (window.__OptimaioAchievedMilestones.has(i)) {
      window.__OptimaioAchievedMilestones.delete(i);
      console.log("ðŸ”„ Milestone reset â†’", i + 1);
    }
  }
});


    const next = config.steps.find(s => value < s.threshold);

    if (!next) {
      msg.textContent = config.content.progressTextAfter || "You have unlocked all rewards!";
      return;
    }

    const remain = next.threshold - value;

    /** â­ DYNAMIC MESSAGE FIX STARTS HERE â­ **/

    const nextIndex = config.steps.indexOf(next);
    const ordinalKey =
      nextIndex === 0 ? "1st goal" :
      nextIndex === 1 ? "2nd goal" :
      nextIndex === 2 ? "3rd goal" :
      `${nextIndex + 1}th goal`;

    const dynamicBefore =
      config.content?.[ordinalKey]?.progressTextBefore?.trim() || "";

    const remainValue =
      config.trackType === "quantity" ? remain : remain.toFixed(2);

    if (dynamicBefore) {
      msg.textContent = fillTemplate(dynamicBefore, { remain: remainValue });
      return;
    }

    /** â­ DEFAULT MESSAGE (Fallback) â­ **/

    msg.textContent =
      config.trackType === "quantity"
        ? `Add ${remain} more items to unlock ${next.beforeLabel}`
        : `Spend â‚¹${remain.toFixed(2)} more to unlock ${next.beforeLabel}`;

    /** â­ DYNAMIC MESSAGE FIX ENDS HERE â­ **/
  }

  document.addEventListener("optimaio:cart:updated", async (e) => {
  const cart = e.detail;  // âœ… works
  const data = await getCampaignData();  // uses shared campaign
  const config = extractSteps(data);
  updateProgress(cart, config);
});


  (async function init() {
    const container = document.getElementById("optimaio-progress-container");
    const data = await getCampaignData();

    const config = extractSteps(data);

    if (!config || !config.steps?.length) {
      container.style.display = "none";
      return;
    }

    renderUI(container, config);

    const cart = await window.OptimaioCartController.getCart();
    updateProgress(cart, config);
  })();
})();
</script>
