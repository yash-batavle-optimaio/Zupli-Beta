<script>
  window.__SHOP_MONEY_FORMAT__ = {{ shop.money_format | json }};
  window.__SHOP_DOMAIN__ = '{{ shop.permanent_domain }}';
  window.__OPTIMAIO_CURRENCIES__ = {{ shop.metafields.optimaio_cart.currencies.value | json }};

  window.__OPTIMAIO_CART__ = {
    settings: {{ shop.metafields.optimaio_cart.cart_settings.value | json }},
    timer: {{ shop.metafields.optimaio_cart.cart_timer_settings.value | json }},
    upsell: {{ shop.metafields.optimaio_cart.upsell_settings.value | json }}
  };

  console.log("üßæ Optimaio Cart Metafields:", window.__OPTIMAIO_CART__);
</script>

<script>
  function normalizeCampaignResponse(raw) {
    // New API shape ‚Üí { campaigns: { campaigns: [] } }
    if (raw && raw.campaigns && Array.isArray(raw.campaigns.campaigns)) {
      return { campaigns: raw.campaigns.campaigns };
    }

    // Old / expected shape ‚Üí { campaigns: [] }
    if (raw && Array.isArray(raw.campaigns)) {
      return raw;
    }

    // Safety fallback
    return { campaigns: [] };
  }
</script>

<script>
  /* ----------------------------------------------------
     üåê GLOBAL OPTIMAIO CAMPAIGN ENGINE
     - In-memory caching ONLY
     - Single fetch lock
  ---------------------------------------------------- */

  window.__OPTIMIAO_FETCH_STATE__ = {
    data: null, // cached campaign data
    pending: null, // shared fetch promise
    lastFetch: 0, // timestamp
    TTL: 60000, // üëà CACHE TIME IN MS (0 = ALWAYS FRESH)
  };

  /* ----------------------------------------------------
     MAIN FETCH FUNCTION (fresh request)
  ---------------------------------------------------- */
  async function fetchCampaignFresh() {
    const state = window.__OPTIMIAO_FETCH_STATE__;
    const start = performance.now();
    const url = `https://campaign-worker.developer-208.workers.dev/?shop=${window.__SHOP_DOMAIN__}`;

    // üîí Prevent parallel fetches
    if (state.pending) return state.pending;

    state.pending = fetch(url, {
      cache: 'no-store',
    })
      .then((res) => res.json())
      .then((json) => {
        const normalized = normalizeCampaignResponse(json);

        state.data = normalized;
        state.lastFetch = Date.now();

        console.log(
          `%c‚ö° Optimaio Fetch (normalized): ${Math.round(performance.now() - start)}ms`,
          'color:#4caf50',
          normalized
        );

        state.pending = null;
        return normalized;
      })

      .catch((err) => {
        console.warn('‚ö†Ô∏è Optimaio Fetch Failed', err);
        state.pending = null;
        throw err;
      });

    return state.pending;
  }

  /* ----------------------------------------------------
     PUBLIC FUNCTION USED BY ALL SECTIONS
  ---------------------------------------------------- */
  window.getCampaignData = async function () {
    const state = window.__OPTIMIAO_FETCH_STATE__;
    const now = Date.now();

    // ‚úî In-memory cache hit
    if (state.TTL > 0 && state.data && now - state.lastFetch < state.TTL) {
      console.log('%cüì¶ Optimaio Campaign (memory cache)', 'color:#2196f3', state.data);
      return state.data;
    }

    // ‚úî Fetch fresh
    return fetchCampaignFresh();
  };

  /* ----------------------------------------------------
     üöÄ OPTIONAL PREFETCH (still memory-only)
  ---------------------------------------------------- */
  window.__OPTIMIAO_PREFETCH__ = fetchCampaignFresh().catch(() => null);
</script>

{% comment %}
  <script>
  /* ----------------------------------------------------
     üåê GLOBAL OPTIMAIO CAMPAIGN ENGINE (1 fetch only)
     Fresh data + Shared across all scripts
  ---------------------------------------------------- */

  window.__OPTIMIAO_FETCH_STATE__ = {
    data: null,       // latest campaign data
    pending: null,    // shared promise
    lastFetch: 0,     // timestamp
    refreshGap: 0     // 0 = always fresh, no caching
  };

  /* ----------------------------------------------------
     MAIN FETCH FUNCTION (always fresh)
  ---------------------------------------------------- */
  async function fetchCampaignFresh() {
    const state = window.__OPTIMIAO_FETCH_STATE__;
    const start = performance.now();

    // If fetch already in progress ‚Üí WAIT for same promise
    if (state.pending) return state.pending;

    // Start new fetch
    state.pending = fetch("/apps/optimaio-cart/activeCampaigns", {
      cache: "no-store"
    })
      .then(res => res.json())
      .then(json => {
        state.data = json;
        state.lastFetch = Date.now();

        console.log(
          `%c‚ö° Optimaio Main Fetch (fresh): ${Math.round(performance.now() - start)}ms`,
          "color:#4caf50",
          json
        );

        state.pending = null;
        return json;
      })
      .catch(err => {
        console.warn("‚ö†Ô∏è Optimaio Fetch Failed", err);
        state.pending = null;
        throw err;
      });

    return state.pending;
  }

  /* ----------------------------------------------------
     PUBLIC function used by ALL Scripts
  ---------------------------------------------------- */
  window.getCampaignData = async function() {
    const state = window.__OPTIMIAO_FETCH_STATE__;
    const now = Date.now();

    // No cache at all ‚Üí ALWAYS fetch fresh
    return fetchCampaignFresh();
  };

  /* ----------------------------------------------------
     OPTIONAL: AUTO REFRESH TIMER (TURN ON IF YOU WANT)
  ---------------------------------------------------- */
  // ‚ùó Set to 0 to disable | Example: 60_000 = refresh every 60 seconds
  const AUTO_REFRESH_TIMER = 0;

  if (AUTO_REFRESH_TIMER > 0) {
    setInterval(() => {
      console.log("%cüîÑ Auto-refreshing campaign (timer)", "color: orange");
      fetchCampaignFresh();
    }, AUTO_REFRESH_TIMER);
  }

  </script>
{% endcomment %}


<script src="{{ 'optimaio-gift.js' | asset_url }}" defer></script>

<script src="{{ 'optimaio.js' | asset_url }}" defer></script>
<script src="{{ 'optimaio-ui-settings.js' | asset_url }}" defer></script>

{{ 'optimaio-core.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme0-color.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme1-color.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme2-color.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme3-color.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme4-color.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme5-color.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme6-color.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme7-color.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme8-color.css' | asset_url | stylesheet_tag }}
{{ 'optimaio-theme9-color.css' | asset_url | stylesheet_tag }}

{% comment %}
  <script>
    (function () {
      function applyOptimaioTheme() {
        const settings = window.__OPTIMAIO_CART__?.settings || {};
        const theme = settings.theme || "theme1";
        const bannerStyle = settings.bannerStyle || {};

        const roots = [
          document.getElementById("optimaio-cart-drawer"),
    document.getElementById("optimaio-corner-cart")
        ].filter(Boolean);

        if (!roots.length) return;

     /* ----------------------------
     1Ô∏è‚É£ Apply theme (SYNC ROOT)
  ---------------------------- */
  document.body.setAttribute("data-optimaio-theme", theme);

  roots.forEach(root => {
    root.setAttribute("data-optimaio-theme", theme);
  });


        /* ----------------------------
           2Ô∏è‚É£ Apply banner style
           Priority: image ‚Üí gradient ‚Üí solid
        ---------------------------- */
        roots.forEach(root => {
          // reset first
          if (root.id === "optimaio-corner-cart") return; // üëà ADD THIS LINE
          root.style.background = "";
          root.style.backgroundImage = "";

          if (bannerStyle.bannerType === "image" && bannerStyle.imageUrl) {
            root.style.backgroundImage = `url(${bannerStyle.imageUrl})`;
            root.style.backgroundSize = "cover";
            root.style.backgroundPosition = "center";
            root.style.backgroundRepeat = "no-repeat";

          } else if (
            bannerStyle.bannerType === "gradient" &&
            bannerStyle.gradientStart &&
            bannerStyle.gradientEnd
          ) {
            root.style.background = `linear-gradient(135deg, ${bannerStyle.gradientStart}, ${bannerStyle.gradientEnd})`;

          } else if (
            bannerStyle.bannerType === "solid" &&
            bannerStyle.solidColor
          ) {
            root.style.background = bannerStyle.solidColor;
          }
        });

        /* ----------------------------
           3Ô∏è‚É£ Apply color variables
        ---------------------------- */
        const colors = settings.colors || {};
        const variableMap = {
          buttonColor: "--accent",
          primaryColor: "--text-primary",
          secondaryColor: "--text-secondary"

        };

        /* ----------------------------
     Progress gradient (OPT-IN)
  ---------------------------- */
  roots.forEach(root => {
    // reset first
    root.style.removeProperty("--progress-start");
    root.style.removeProperty("--progress-end");
    root.removeAttribute("data-progress-gradient");

    // apply only if BOTH provided
    if (colors.progressStart && colors.progressEnd) {
      root.style.setProperty("--progress-start", colors.progressStart);
      root.style.setProperty("--progress-end", colors.progressEnd);
      root.setAttribute("data-progress-gradient", "true");
    }
  });


        roots.forEach(root => {
          Object.entries(variableMap).forEach(([key, cssVar]) => {
            if (colors[key]) {
              root.style.setProperty(cssVar, colors[key]);
            }
          });
        });

        /* ----------------------------
           4Ô∏è‚É£ Custom CSS (TOP priority)
        ---------------------------- */
        if (settings.customCSS?.trim()) {
          let style = document.getElementById("optimaio-custom-css");
          if (!style) {
            style = document.createElement("style");
            style.id = "optimaio-custom-css";
            document.head.appendChild(style);
          }
          style.textContent = settings.customCSS;
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", applyOptimaioTheme);
      } else {
        applyOptimaioTheme();
      }
    })();
    </script>



  <script>
  (function () {
    const settings = window.__OPTIMAIO_CART__?.settings || {};
    const zIndex = settings.zIndex;

    if (!zIndex || zIndex === "auto") return;

    const z = Number(zIndex);
    if (isNaN(z)) return;

    const drawer = document.getElementById("optimaio-cart-drawer");
    const corner = document.getElementById("optimaio-corner-cart");

    if (drawer) drawer.style.setProperty("--optimaio-z-index", z);
    if (corner) corner.style.setProperty("--optimaio-z-index", z);
  })();
  </script>
{% endcomment %}

<!-- Optimaio Universal Responsive Cart Drawer -->
<div id="optimaio-corner-cart">
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="lucide lucide-shopping-cart-icon lucide-shopping-cart"
  >
    <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
  </svg>
  {% comment %} <span id="optimaio-corner-cart-count">0</span> {% endcomment %}
</div>

<div id="optimaio-cart-drawer" class="optimaio-cart-drawer" data-active-tab="cart">
  <!-- Header -->
  <div class="optimaio-cart-drawer__header">
    <h2 class="optimaio-cart-tile">My Cart</h2>
    <button type="button" class="optimaio-cart-drawer__close">
      <svg
        xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M18 6 6 18"/>
        <path d="M6 6 18 18"/>
      </svg>
    </button>
  </div>

  <div class="optimaio-announcement-bar">
    <button class="optimaio-announcement-arrow left" aria-label="Previous">‚Äπ</button>

    <div
      class="optimaio-announcement-viewport"
      id="optimaio-announcement-viewport"
    ></div>

    <button class="optimaio-announcement-arrow right" aria-label="Next">‚Ä∫</button>
  </div>

  <div id="optimaio-countdown" class="optimaio-countdown" style="display:none;">
    <svg
      xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="1.5"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <circle cx="12" cy="12" r="9"/>
      <path d="M12 7v5l3 2"/>
    </svg>
    <span class="optimaio-countdown-label" id="optimaio-countdown-label"></span>
    <span id="optimaio-countdown-time">
      <span class="optimaio-time"><strong>00</strong>d :</span>
      <span class="optimaio-time"><strong>00</strong>h :</span>
      <span class="optimaio-time"><strong>00</strong>m :</span>
      <span class="optimaio-time"><strong>00</strong>s</span>
    </span>
  </div>

  <!-- Middle Scrollable Body -->
  <div class="optimaio-cart-drawer__middle">
    <!-- Optimaio Flow Loader -->
    <div id="optimaio-cart-loading" class="optimaio-cart-loading hidden">
      <div class="optimaio-loader-bar">
        <span class="optimaio-loader-fill"></span>
      </div>
    </div>

    <!-- TAB: CART -->
    {% comment %} <div class="optimaio-cart-drawer-border-radius"> {% endcomment %}
    <div class="optimaio-cart-tab optimaio-cart-tab--cart" data-tab="cart">
      {% comment %} </div> {% endcomment %}

      {% render 'optimaio-progress-bar' %}

      <div class="optimaio-cart-drawer__items"></div>

      <div class="optimaio-cart-drawer__empty" style="display:none;">
        <p>Your cart is empty</p>
        <a href="/" class="optimaio-continue-btn">Continue Shopping</a>
      </div>
    </div>

    <!-- TAB: OFFERS -->
    <div class="optimaio-cart-tab optimaio-cart-tab--offers" data-tab="offers">
      {% render 'optimaio-offers' %}
    </div>
  </div>

  <div class="optimaio-cart-drawer__recommendations">
    <div class="optimaio-recommendations-list"></div>
  </div>

  <div class="optimaio-cart-drawer-oneclick-upsell">
    <div id="optimaio-oneclick-upsell" class="optimaio-oneclick-upsell"></div>
  </div>

  <!-- Footer Summary -->
  <div class="optimaio-cart-drawer__summary-checkout">
    <div class="optimaio-cart-actions">
      <button class="optimaio-action-btn" data-sheet="note">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-notebook-pen-icon lucide-notebook-pen"
        >
          <path d="M13.4 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7.4"/><path d="M2 6h4"/><path d="M2 10h4"/><path d="M2 14h4"/><path d="M2 18h4"/><path d="M21.378 5.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/>
        </svg>
        Add note
      </button>

      <button class="optimaio-action-btn" data-sheet="discount">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-ticket-percent-icon lucide-ticket-percent"
        >
          <path d="M2 9a3 3 0 1 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 1 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M9 9h.01"/><path d="m15 9-6 6"/><path d="M15 15h.01"/>
        </svg>
        Discount
      </button>
    </div>

    <div class="optimaio-cart-drawer__summary">
      <div class="optimaio-discount-row">
        <span class="optimaio-discount-label">Discount:</span>
        <span class="optimaio-discount-amount">‚Çπ0</span>
      </div>
      <div class="optimaio-total-row">
        <span class="optimaio-total-label">Total:</span>
        <span class="optimaio-total-amount">‚Çπ0</span>
      </div>
    </div>
    <button class="optimaio-checkout-btn">Proceed to Checkout</button>
  </div>

  <!-- Footer Tabs -->
  <div class="optimaio-cart-drawer__footer">
    <button class="optimaio-tab-btn active" data-target="cart">
      <svg
        xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="8" cy="21" r="1"/>
        <circle cx="19" cy="21" r="1"/>
        <path d="M2 2h3l2.2 11.2a2 2 0 0 0 2 1.6h7.9a2 2 0 0 0 2-1.6L23 6H6"/>
      </svg>
      Cart
    </button>
    <button class="optimaio-tab-btn" data-target="offers">
      <svg
        xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M20 12v10H4V12"/>
        <path d="M2 7h20v5H2z"/>
        <path d="M12 22V7"/>
        <path d="M12 7H7.5a2.5 2.5 0 1 1 0-5C10 2 12 7 12 7z"/>
        <path d="M12 7h4.5a2.5 2.5 0 1 0 0-5C14 2 12 7 12 7z"/>
      </svg>
      Offers
    </button>
  </div>

  <div class="optimaio-bottom-sheet" id="optimaio-sheet">
    <div class="optimaio-sheet-header">
      <span id="optimaio-sheet-title"></span>
      <button class="optimaio-sheet-close">‚úï</button>
    </div>

    <div class="optimaio-sheet-body">
      <!-- NOTE -->
      <div class="optimaio-sheet-content" data-content="note">
        <textarea
          class="optimaio-note-textarea"
          placeholder="Special instructions for seller"
        ></textarea>

        <button class="optimaio-sheet-primary">Save</button>
      </div>

      <!-- DISCOUNT -->
      <div class="optimaio-sheet-content" data-content="discount">
        <div class="optimaio-discount-field">
          <input
            type="text"
            class="optimaio-discount-input"
            placeholder="Enter discount code"
          >
          <button class="optimaio-discount-apply">Apply</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% comment %}
  <script>
  (function () {
    function applyCartTexts() {
      const texts = window.__OPTIMAIO_CART__?.settings?.cartTexts;
      if (!texts) return;

      /* =============================
         CART ‚Äî HEADER
      ============================= */
      if (texts.header?.cartHeaderText) {
        const title = document.querySelector(".optimaio-cart-tile");
        if (title) title.textContent = texts.header.cartHeaderText;
      }

      /* =============================
         CART ‚Äî FOOTER TABS
      ============================= */
      if (texts.footer?.cartButtonText) {
        const cartTab = document.querySelector('.optimaio-tab-btn[data-target="cart"]');
        if (cartTab) {
          cartTab.childNodes[cartTab.childNodes.length - 1].textContent =
            " " + texts.footer.cartButtonText;
        }
      }

      if (texts.footer?.offersButtonText) {
        const offersTab = document.querySelector('.optimaio-tab-btn[data-target="offers"]');
        if (offersTab) {
          offersTab.childNodes[offersTab.childNodes.length - 1].textContent =
            " " + texts.footer.offersButtonText;
        }
      }

      /* =============================
         CART ‚Äî SUMMARY + BUTTONS
      ============================= */
      if (texts.side?.discountText) {
        const el = document.querySelector(".optimaio-discount-label");
        if (el) el.textContent = texts.side.discountText + ":";
      }

      if (texts.side?.totalText) {
        const el = document.querySelector(".optimaio-total-label");
        if (el) el.textContent = texts.side.totalText + ":";
      }

      if (texts.side?.addNoteButtonText) {
        document
          .querySelectorAll('.optimaio-action-btn[data-sheet="note"]')
          .forEach(btn => {
            btn.lastChild.textContent = " " + texts.side.addNoteButtonText;
          });
      }

      if (texts.side?.discountCodeButtonText) {
        document
          .querySelectorAll('.optimaio-action-btn[data-sheet="discount"]')
          .forEach(btn => {
            btn.lastChild.textContent = " " + texts.side.discountCodeButtonText;
          });
      }

      if (texts.side?.checkoutButtonText) {
        const btn = document.querySelector(".optimaio-checkout-btn");
        if (btn) btn.textContent = texts.side.checkoutButtonText;
      }

      /* =============================
         OFFERS ‚Äî TITLE + BADGES
         (NEW, minimal)
      ============================= */
      const offers = texts.offers;

      if (offers?.offerHeaderText) {
        const title = document.querySelector(".optimaio-offers-title");
        if (title) title.textContent = offers.offerHeaderText;
      }

      if (offers?.badgeLockedText) {
        document
          .querySelectorAll(".optimaio-offer-badge.locked")
          .forEach(el => {
            el.textContent = offers.badgeLockedText;
          });
      }

      if (offers?.badgeUnlockedText) {
        document
          .querySelectorAll(".optimaio-offer-badge.unlocked")
          .forEach(el => {
            el.textContent = offers.badgeUnlockedText;
          });
      }
    }

    /* Initial load */
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", applyCartTexts);
    } else {
      applyCartTexts();
    }

    /* Re-apply on dynamic updates */
    document.addEventListener("optimaio:open", applyCartTexts);
    document.addEventListener("optimaio:gifts:updated", applyCartTexts);
  })();
  </script>
{% endcomment %}

{% comment %}
  <script>
  (function () {
    if (window.__OPTIMAIO_ONECLICK_INIT__) return;
    window.__OPTIMAIO_ONECLICK_INIT__ = true;

    function extractVariantId(gid) {
      return gid?.split("/").pop();
    }

    function formatMoney(price) {
      try {
        return Shopify.formatMoney(
          Math.round(Number(price) * 100),
          window.__SHOP_MONEY_FORMAT__
        );
      } catch {
        return price;
      }
    }

    async function getCart() {
      return window.OptimaioCartController?.getCart();
    }

    async function addUpsell(variantId, hide) {
      await fetch("/cart/add.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: variantId,
          quantity: 1,
          properties: hide ? { __optimaio_hidden_upsell__: true } : {}
        })
      });
    }

    async function removeUpsell(cart, variantId) {
      const item = cart.items.find(i => i.variant_id == variantId);
      if (!item) return;

      await fetch("/cart/change.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: item.key, quantity: 0 })
      });
    }

    async function render() {
      const upsell = window.__OPTIMAIO_CART__?.upsell?.oneClickUpsell;
      if (!upsell?.enabled) return;

      const container = document.getElementById("optimaio-oneclick-upsell");
      if (!container) return;

      const p = upsell.product;
      if (!p?.availableForSale) {
        container.innerHTML = "";
        return;
      }

      const variantId = extractVariantId(p.id);
      if (!variantId) return;

      const cart = await getCart();
      const inCart = cart?.items?.some(i => i.variant_id == variantId);

      const isCheckbox = upsell.ctaType === "checkbox";
      const isHidden = upsell.showInCartList === false;

      container.innerHTML = `
        <div class="optimaio-mini-upsell">
          ${upsell.showProductImage !== false ? `
            <img src="${p.image?.url || ""}" class="optimaio-mini-upsell__image">
          ` : ""}

          <div class="optimaio-mini-upsell__info">
            <div class="optimaio-mini-upsell__title">${p.productTitle}</div>
            <div class="optimaio-mini-upsell__price">${formatMoney(p.price)}</div>
          </div>

          ${
            isCheckbox
              ? `<label class="optimaio-upsell-checkbox">
                  <input type="checkbox" ${inCart ? "checked" : ""}>
                  <span>${inCart ? "Added" : "Add"}</span>
                </label>`
              : `<button class="optimaio-mini-upsell__btn">
                  ${inCart ? "Remove" : "Add"}
                </button>`
          }
        </div>
      `;

      if (isCheckbox) {
        const cb = container.querySelector("input");
        cb.onchange = async () => {
          cb.disabled = true;

          const freshCart = await getCart();
          const exists = freshCart.items.some(i => i.variant_id == variantId);

          if (cb.checked && !exists) {
            await addUpsell(variantId, isHidden);
          }

          if (!cb.checked && exists) {
            await removeUpsell(freshCart, variantId);
          }

          await window.OptimaioCartController.refresh();
          cb.disabled = false;
        };
      } else {
        const btn = container.querySelector("button");
        btn.onclick = async () => {
          btn.disabled = true;

          const freshCart = await getCart();
          const exists = freshCart.items.some(i => i.variant_id == variantId);

          exists
            ? await removeUpsell(freshCart, variantId)
            : await addUpsell(variantId, isHidden);

          await window.OptimaioCartController.refresh();
          btn.disabled = false;
        };
      }
    }

    document.addEventListener("DOMContentLoaded", render);
    document.addEventListener("optimaio:open", render);
    document.addEventListener("optimaio:cart:updated", render);
  })();
  </script>
{% endcomment %}


{% comment %}
  <script>
    (function () {
      const settings = window.__OPTIMAIO_CART__?.settings;
      const widget = settings?.cartWidget;

      const cart = document.getElementById("optimaio-corner-cart");
      if (!cart || !widget) return;

      /* ----------------------------
         1Ô∏è‚É£ Show / Hide
      ---------------------------- */
      if (!widget.showFloatingWidget) {
        cart.style.display = "none";
        return;
      }

      cart.style.display = "flex";

      /* ----------------------------
         2Ô∏è‚É£ Position (left / right)
      ---------------------------- */
      cart.classList.remove("position-left", "position-right");

      if (widget.position === "left") {
        cart.classList.add("position-left");
      } else {
        cart.classList.add("position-right"); // default
      }

      /* ----------------------------
         3Ô∏è‚É£ Widget Color
      ---------------------------- */
      if (widget.widgetColor) {
        cart.style.background = widget.widgetColor;
      }

    })();
    </script>


  <script>
    (function () {
      const sheet = document.getElementById("optimaio-sheet");
      const title = document.getElementById("optimaio-sheet-title");

      /* =============================
     FEATURE FLAGS
  ============================= */
  const settings = window.__OPTIMAIO_CART__?.settings || {};
  const features = settings.cartFeatures || {};

  const NOTES_ENABLED = features.orderNotes !== false;
  const DISCOUNT_ENABLED = features.discountCodeInput !== false;

  /* =============================
     VISIBILITY CONTROL
  ============================= */
  if (!NOTES_ENABLED) {
    document
      .querySelectorAll('.optimaio-action-btn[data-sheet="note"]')
      .forEach(el => el.style.display = "none");

    sheet
      .querySelectorAll('.optimaio-sheet-content[data-content="note"]')
      .forEach(el => el.remove());
  }

  if (!DISCOUNT_ENABLED) {
    document
      .querySelectorAll('.optimaio-action-btn[data-sheet="discount"]')
      .forEach(el => el.style.display = "none");

    sheet
      .querySelectorAll('.optimaio-sheet-content[data-content="discount"]')
      .forEach(el => el.remove());
  }


      if (!sheet) return;

      /* -----------------------------
         OPEN SHEET
      ----------------------------- */
      document.addEventListener("click", e => {
        const actionBtn = e.target.closest(".optimaio-action-btn");
        if (!actionBtn) return;

        const type = actionBtn.dataset.sheet;

        if (type === "note" && !NOTES_ENABLED) return;
  if (type === "discount" && !DISCOUNT_ENABLED) return;


        // Set title
        title.textContent =
          type === "note"
            ? "Add note for seller"
            : "Apply discount code";

        // Show correct content
        sheet.querySelectorAll(".optimaio-sheet-content").forEach(c => {
          c.classList.toggle("active", c.dataset.content === type);
        });

        sheet.classList.add("open");
      });

      /* -----------------------------
         CLOSE SHEET
      ----------------------------- */
      function closeSheet() {
        sheet.classList.remove("open");
      }

      document.addEventListener("click", e => {
        if (e.target.closest(".optimaio-sheet-close")) {
          closeSheet();
        }
      });

      /* -----------------------------
         SAVE NOTE (REAL SHOPIFY)
      ----------------------------- */
      document.addEventListener("click", async e => {
        const saveBtn = e.target.closest(".optimaio-sheet-primary");
        if (!saveBtn) return;
        if (!NOTES_ENABLED) return;


        const textarea = sheet.querySelector(".optimaio-note-textarea");
        if (!textarea) return;

        saveBtn.disabled = true;

        try {
          await fetch("/cart/update.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ note: textarea.value })
          });

          // Refresh cart UI safely
          window.OptimaioCartController?.refresh();

          closeSheet(); // ‚úÖ FIXED: closes popup

        } catch (err) {
          console.error("Failed to save note", err);
        } finally {
          saveBtn.disabled = false;
        }
      });

      /* -----------------------------
         APPLY DISCOUNT (REAL SHOPIFY)
      ----------------------------- */
      document.addEventListener("click", e => {
        const applyBtn = e.target.closest(".optimaio-discount-apply");
        if (!applyBtn) return;
        if (!DISCOUNT_ENABLED) return;


        const input = sheet.querySelector(".optimaio-discount-input");
        if (!input || !input.value.trim()) return;

        applyBtn.disabled = true;

        // Official Shopify method
        window.location.href =
          "/discount/" + encodeURIComponent(input.value.trim());
      });



    })();
    </script>
    <script>
      fetch("/cart.js")
    .then(r => r.json())
    .then(cart => console.log(cart.note));

    </script>

    <script>
      (function () {
        const announcement =
          window.__OPTIMAIO_CART__?.settings?.announcementBar;

        if (!announcement) return;

        const messages = Array.isArray(announcement.messages)
          ? announcement.messages.filter(Boolean)
          : [];

        if (!messages.length) return;

        const autoScroll = announcement.autoScroll === true;

        const viewport = document.getElementById("optimaio-announcement-viewport");
        if (!viewport) return;

        const bar = viewport.closest(".optimaio-announcement-bar");
        const prevBtn = bar.querySelector(".optimaio-announcement-arrow.left");
        const nextBtn = bar.querySelector(".optimaio-announcement-arrow.right");

        /* ----------------------------
           1Ô∏è‚É£ Render messages
        ---------------------------- */
        viewport.innerHTML = "";

        messages.forEach((text, i) => {
          const el = document.createElement("div");
          el.className = "optimaio-announcement-item";
          if (i === 0) el.classList.add("active");
          el.textContent = text;
          viewport.appendChild(el);
        });

        const items = viewport.querySelectorAll(".optimaio-announcement-item");
        let index = 0;

        /* ----------------------------
           2Ô∏è‚É£ AUTO SCROLL MODE
        ---------------------------- */
        if (autoScroll && items.length > 1) {
          prevBtn.style.display = "none";
          nextBtn.style.display = "none";

          if (window.__OPTIMAIO_ANNOUNCEMENT_TIMER__) {
            clearInterval(window.__OPTIMAIO_ANNOUNCEMENT_TIMER__);
          }

          window.__OPTIMAIO_ANNOUNCEMENT_TIMER__ = setInterval(() => {
            items[index].classList.remove("active");
            index = (index + 1) % items.length;
            items[index].classList.add("active");
          }, 4000);

          return;
        }

        /* ----------------------------
           3Ô∏è‚É£ MANUAL MODE (ARROWS)
        ---------------------------- */
        if (!autoScroll && items.length > 1) {
          prevBtn.style.display = "block";
          nextBtn.style.display = "block";

          function show(i) {
            items[index].classList.remove("active");
            index = (i + items.length) % items.length;
            items[index].classList.add("active");
          }

          prevBtn.onclick = () => show(index - 1);
          nextBtn.onclick = () => show(index + 1);
        }
      })();
      </script>





  <script>
    (function () {
      const data = window.__OPTIMAIO_CART__ || {};
      const timer = data.timer;

          /* ----------------------------
         üßπ CLEAR CART HELPER
      ---------------------------- */
      async function optimaioClearCart() {
        try {
          await fetch("/cart/clear.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });

          console.log("üßπ Optimaio: Cart cleared by timer");

          // Refresh Optimaio UI
          window.OptimaioCartController?.refresh();

          // Optional lifecycle event
          document.dispatchEvent(
            new CustomEvent("optimaio:cart:cleared", {
              detail: { source: "timer" }
            })
          );

        } catch (err) {
          console.error("‚ùå Optimaio: Failed to clear cart", err);
        }
      }


      const container = document.getElementById("optimaio-countdown");

  if (!timer || timer.status !== "active") {
    if (container) container.remove();
    return;
  }

  // ‚úÖ ADD THIS LINE
  container.style.display = "flex";

  const label = container.querySelector("#optimaio-countdown-label");
  if (label) {
    label.textContent = timer.timerText || "Offer ends in";
  }


      const boxes = container.querySelectorAll(".optimaio-time strong");
      if (boxes.length !== 4) return;

      const STORAGE_KEY = "optimaio_timer_start";

      /* ----------------------------
         Helpers
      ---------------------------- */
      function parseDate(date, time) {
        return new Date(`${date} ${time || "12:00 AM"}`).getTime();
      }

      function pad(n) {
        return String(n).padStart(2, "0");
      }

      /* ----------------------------
     ACTIVE DATES (VISIBILITY ONLY)
  ---------------------------- */
  let isVisible = true;
  const now = Date.now();

  if (timer.activeDates?.start?.date) {
    const start = parseDate(
      timer.activeDates.start.date,
      timer.activeDates.start.time
    );
    if (now < start) {
      isVisible = false;
    }
  }

  if (timer.activeDates?.end?.date) {
    const end = parseDate(
      timer.activeDates.end.date,
      timer.activeDates.end.time
    );
    if (now > end) {
      isVisible = false;
    }
  }

  container.style.display = isVisible ? "flex" : "none";

      /* ----------------------------
         DETERMINE END TIME
      ---------------------------- */
      let endTime;

      /* üîÅ MODE: DURATION (cart-based) */
      if (timer.timerConfig.timerMode === "duration") {
        let startTime = localStorage.getItem(STORAGE_KEY);

        // ‚è± First product added ‚Üí start timer
        if (!startTime) {
          startTime = Date.now();
          localStorage.setItem(STORAGE_KEY, startTime);
        }

        const d = timer.timerConfig.duration;
        endTime =
          Number(startTime) +
          (+d.hours * 3600000) +
          (+d.minutes * 60000) +
          (+d.seconds * 1000);
      }

      /* üìÖ MODE: SPECIFIC (fixed end time) */
      if (
        timer.timerConfig.timerMode === "specific" &&
        timer.timerConfig.activeDates?.end?.date
      ) {
        endTime = parseDate(
          timer.timerConfig.activeDates.end.date,
          timer.timerConfig.activeDates.end.time
        );
      }

      if (!endTime) return;

      /* ----------------------------
         COUNTDOWN LOOP
      ---------------------------- */
      let interval; // üëà declare upfront

  function updateCountdown() {
    let diff = endTime - Date.now();

    if (diff <= 0) {
      if (interval) clearInterval(interval);

      const isDuration = timer.timerConfig.timerMode === "duration";
      const shouldLoop =
        isDuration && timer.afterAction === "refresh";

      /* üîÅ LOOP ONLY */
      if (shouldLoop) {
        const d = timer.timerConfig.duration;
        const newStart = Date.now();

        localStorage.setItem(STORAGE_KEY, newStart);

        endTime =
          newStart +
          (+d.hours * 3600000) +
          (+d.minutes * 60000) +
          (+d.seconds * 1000);

        updateCountdown();
        interval = setInterval(updateCountdown, 1000);
        return;
      }

      /* üßπ CLEAR CART */
      if (timer.afterAction === "clear_cart") {
        optimaioClearCart();
      }

      /* ‚ùå FINAL EXPIRE */
      localStorage.removeItem(STORAGE_KEY);

      if (timer.expiredMessage) {
        container.textContent = timer.expiredMessage;
      } else {
        container.style.display = "none";
      }

      return;
    }


    const days = Math.floor(diff / 86400000);
    diff -= days * 86400000;

    const hours = Math.floor(diff / 3600000);
    diff -= hours * 3600000;

    const minutes = Math.floor(diff / 60000);
    diff -= minutes * 60000;

    const seconds = Math.floor(diff / 1000);

    boxes[0].textContent = pad(days);
    boxes[1].textContent = pad(hours);
    boxes[2].textContent = pad(minutes);
    boxes[3].textContent = pad(seconds);
  }

  // ‚úÖ start loop AFTER declaration
  updateCountdown();
  interval = setInterval(updateCountdown, 1000);

    })();
    </script>




  <script>
    (function () {
      /* ----------------------------------
         1Ô∏è‚É£ Detect cart page
      ---------------------------------- */
      const isCartPage =
        location.pathname === "/cart" ||
        document.body.classList.contains("template-cart");

      if (!isCartPage) return;

      /* ----------------------------------
         2Ô∏è‚É£ Mark page context
      ---------------------------------- */
      document.body.classList.add("optimaio-cart-page-context");



      /* ----------------------------------
         3Ô∏è‚É£ Locate drawer
      ---------------------------------- */
      const drawer = document.getElementById("optimaio-cart-drawer");
      if (!drawer) return;

      /* ----------------------------------
         4Ô∏è‚É£ Move drawer into <main>
      ---------------------------------- */
      const main =
        document.querySelector("main") ||
        document.getElementById("MainContent");

      if (main && !main.contains(drawer)) {
        main.prepend(drawer);
      }

      /* ----------------------------------
         5Ô∏è‚É£ Switch to PAGE mode
         (‚ö†Ô∏è DO NOT remove .open anymore)
      ---------------------------------- */
      drawer.classList.add("optimaio-cart-page");
      drawer.classList.add("open"); // ‚úÖ REQUIRED for CSS + logic
      drawer.setAttribute("data-context", "page");

      /* ----------------------------------
         6Ô∏è‚É£ üî• FORCE FULL INIT (REAL FIX)
      ---------------------------------- */
      function forceOptimaioInit() {
        // 1Ô∏è‚É£ Logical open flag (internal guards)
        window.__OPTIMAIO_DRAWER_OPEN__ = true;

        // 2Ô∏è‚É£ Force cart render
        if (typeof window.getCartAndRender === "function") {
          window.getCartAndRender();
        }

        // 3Ô∏è‚É£ Force controller refresh (items, gifts, progress)
        window.OptimaioCartController?.refresh();

        // 4Ô∏è‚É£ Fire lifecycle event (observers, BXGY, progress bar)
        document.dispatchEvent(
          new CustomEvent("optimaio:open", {
            detail: { context: "page", silent: true }
          })
        );
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", forceOptimaioInit);
      } else {
        forceOptimaioInit();
      }
    })();
    </script>
{% endcomment %}

{% schema %}
{
  "name": "Optimaio Corner Cart",
  "target": "body",
  "settings": []
}
{% endschema %}
